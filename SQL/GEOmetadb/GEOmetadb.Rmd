---
title: "GEOmetadb"
author: "yincy"
date: "3/9/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(GEOmetadb)
library(magrittr)
library(tidyverse)
```

## Getting the GEOmetadb database  
```{r}
if(!file.exists("GEOmetadb.sqlite")) getSQLiteFile()
```


## What is GEOmetadb  
The GEOmetadb package is an attempt to make querying the metadata describing microarray experiments, platforms, and datasets both easier and more powerful. At the heart of GEOmetadb is a SQLite database that stores nearly all the metadata associated with all GEO data types including GEO samples (GSM), GEO platforms (GPL), GEO data series (GSE), and curated GEO datasets (GDS), as well as the relationships between these data types. This database is generated by our server by parsing all the records in GEO and needs to be downloaded via a simple helper function to the user’s local machine before GEOmetadb is useful. Once this is done, the entire GEO database is accessible with simple SQL-based queries. With the GEOmetadb database, queries that are simply not possible using NCBI tools or web pages are often quite simple.  

### Conversion capabilities  
A very typical problem for large-scale consumers of GEO data is to determine the relationships between various GEO accession types. As examples, consider the following questions:  

- What samples are associated with GEO platform "GPL96", which represents the Affymetrix hgu133a array?  
- What GEO Series were performed using GPL96?  
- What samples are in my favorite three GEO Series records?  
- How many samples are associated with the ten most popular GEO platforms?  

Because these types of questions are common, GEOmetadb contains the function geoConvert that addresses these questions directly and efficiently.  

```{r}
file.info("/home/yincy/git/Data/GEOmetadb.sqlite")
```

Now, the SQLite file is available for connection. The standard DBI functionality as implemented in RSQLite function dbConnect makes the connection to the database. The dbDisconnect function disconnects the connection.  
```{r}
con <- dbConnect(drv = SQLite(), "/home/yincy/git/Data/GEOmetadb.sqlite")

dbDisconnect(con)
# The variable `con` is an RSQLite connection object.  
```


## Examples  
### Interacting with the database  
```{r}
con <- dbConnect(drv = SQLite(), "/home/yincy/git/Data/GEOmetadb.sqlite")
```

```{r, fig.cap="relationships between GEOmetadb tables"}
knitr::include_graphics(path = "/home/yincy/git/Bioconductor/SQL/GEOmetadb/figures/GEOmetadb.png")
```


The `dbListTables` functions lists all the tables in the SQLite database handled by the connection object `con`.  
```{r}
geo_table <- dbListTables(conn = con)
```

`dbListFields` function that can list database fields associated with a table.  
```{r}
dbListFields(conn = con, name = "gds")
```

Sometimes it is useful to get the actual SQL schema associated with a table. Here, we get the table schema for the gpl table.  
```{r}
dbGetQuery(conn = con, statement = "PRAGMA TABLE_INFO(gpl)")
```


### Writing SQL quries and getting results  
select 5 records from the *gettable* and show the first 7 columns.  
```{r}
rs <- dbGetQuery(conn = con, statement = "select title, gse from gse limit 5")
rs %>% dim()
rs
```

Get the GEO series accession and title from GEO series that were submitted by “Sean Davis”. The “%” sign is used in combination with the “like” operator to do a “wildcard” search for the name “Sean Davis” with any number of characters before or after or between “Sean” and “Davis”.  
```{r}
rs <- dbGetQuery(conn = con, statement = paste("select gse,title from gse where", 
                 "contributor like '%Sean%Davis%'", sep = " "))
rs
```


```{r}
rs <- dbGetQuery(conn = con, statement = paste("select gsm,supplementary_file", 
                                               "from gsm where gpl='GPL96'", 
                                               "and supplementary_file like '%CEL.gz'", sep = " "))
rs %>% .[1:5, ]
```


```{r}
rs <- dbGetQuery(con, statement = paste("select gpl.bioc_package, gsm.gpl", 
                                        "gsm, gsm.supplementary_file", 
                                        "from gsm join gpl on gsm.gpl=gpl.gpl", 
                                        "and gsm.supplementary_file like '%CEL.gz'", sep = " "))
rs %>% .[1:5, ]
```

```{r}
rs <- dbGetQuery(con, paste("select gpl.bioc_package, gsm.gpl", 
                            "gsm, gsm.supplementary_file", 
                            "from gsm join gpl on gsm.gpl=gpl.gpl", 
                            "where gpl.manufacturer='Affymetrix'", 
                            "and gsm.supplementary_file like '%CEL.gz'"))
rs %>% .[1:5, ]
```

### Conversion of GEO entity types  
Large-scale consumers of GEO data might want to convert GEO entity type from one to others, e.g. finding all GSM and GSE associated with ‘GPL96’. Function goeConvert does the conversion with a very fast mapping between entity types.  

Convert 'GPL96' to other possible types in the GEOmetadb.sqlite  
```{r}
conversion <- geoConvert(in_list = 'GPL96', sqlite_db_name = "/home/yincy/git/Data/GEOmetadb.sqlite")
lapply(conversion, dim)
```

```{r}
conversion$gsm %>% .[1:5, ]
```

```{r}
conversion$gse %>% .[1:5, ]
```

```{r}
conversion$gds %>% .[1:5, ]
```

```{r}
conversion$sMatrix %>% .[1:5, ]
```


### Mappings between GPL and Bioconductor microarry annotation packages  
The function getBiocPlatformMap is to get GPL information of a given list of Bioconductor microarry annotation packages. Note currently the GEOmetadb does not contains all the mappings, but we are trying to construct a relative complete list.  

Get GPL information of 'hgu133a' and 'hgu95av2'  
```{r}
getBiocPlatformMap(con, bioc = c("hgu133a", "hgu95av2"))
```


### More advanced queries  
Now, for something a bit more complocated, we would like to find all the human breast cancer-related Affymetrix gene expression GEO series.  
```{r}
sql <- paste("SELECT DISTINCT gse.title, gse.gse", 
             "FROM", 
             " gsm JOIN gse_gsm ON gsm.gsm=gse_gsm.gsm", 
             " JOIN gse ON gse_gsm.gse=gse.gse", 
             " JOIN gse_gpl ON gse_gpl.gse=gse.gse", 
             " JOIN gpl ON gse_gpl.gpl=gpl.gpl", 
             "WHERE", 
             " gsm.molecule_ch1 like '%total RNA%' AND", 
             " gse.title LIKE '%breast cancer%' AND", 
             " gpl.organism LIKE '%Homo sapiens%'", sep =  " ")

rs <- dbGetQuery(con, sql)
dim(rs)
rs %>% .[1:5, ]
```

### A worldcloud of GSE titles  
```{r}
library(tm)
library(wordcloud)

gseTitle <- dbGetQuery(con, "select title from gse")
corp <- VCorpus(VectorSource(gseTitle))
corp <- tm_map(corp, removePunctuation)
corp <- tm_map(corp, content_transformer(tolower))
corp <- tm_map(corp, removeNumbers)
corp <- tm_map(corp, function(x){removeWords(x, stopwords())})
term_matrix <- TermDocumentMatrix(corp)
term_matrix <- as.matrix(term_matrix)
v <- sort(rowSums(term_matrix), decreasing = T)
d <- data.frame(word = names(v), freq = v)
n <- 100
wordcloud(d[1:n, ]$word, d[1:n, ]$freq)
```


```{r}
dbDisconnect(conn = con)
```




















---
title: "array_analysis"
author: "yincy"
date: "11/26/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

### Overview  
生物芯片实际上就是一堆基因特异探针的集成。当mRNA或cDNA文库标记后与这些探针相杂交，经洗脱，与探针有特异性结合的cDNA就保留了下来，因为它本身带有荧光标计，所以可以被成像系统捕捉下来。为了减少实验产生的噪音，Affy基因芯片在设计时，对每个基因都集成了20组不同的探针，这些特异性探针每个都由25个碱基组成，被称为Perfect Match(PM)探针。与其直接相邻的，也是20组不同探针，这些探针与前面所提的探针序列基本相同，只是正中间的一个碱基被换成了非特异的碱基，理论上来讲，它们应该很难与特异性探针形成相同的阳性结果。而这20组探针被称为MisMatch(MM)探针。有了MM探针，基因芯片就有了阴对内参，可以用于对杂交效果的检测。

Affymetrix公司发展了MAS5算法，专门用来对实验数据进行去背景预处理。MAS5算法非常小心地使用MM做为背景，实现信噪分离，并且综合20组探针的结果给于每个目标基因的信息。  

但是要达到任何一个目的都会有多种算法，人们有时候倾向于尝试不同的算法来得到自己满意的结果，于是对原始数据的处理也变得重要。生物芯片生成的原始图片，我们把它称为原始数据(raw data)。原始数据保存格式为CEL格式，与之相对应，还需要基因芯片探针排布的信息，这些信息保存为CDF格式。因为商品化的microarray只因物种的不同排布会不同，所以相同型号的芯片使用相同的CDF文件。必要时可以去公司网站上下载CDF文件。  

而每一个探针组都均匀包含了目标基因3’至5’不同区段特异序列。这种设计一方面可以通过均衡它们结果的方式来获取目标基因的表达强度（这一过程被称为总结步骤（summarization step）），另一方面，它也可以提供mRNA降解的程度信息。我们知道一般mRNA都是按5’端至3’端的顺序来降解的，而这些探针组应该能体现这一趋势。  


### MAS5 标准化  
MAS5算法是采用了比较直接的策略，任何操作都是简单易懂的。每一块芯片上所有探针的平均值被用于决定尺度因子（scaling factor）。在Bioconductor当中，我们假设每个芯片上所有基因定量后的线性坐标表达值为介于0~200之间的数字，平均值(target)为100。如果有两块芯片我们需要比较，第一块芯片的平均值为50，第二块芯片的平均值 为200。那么它们的尺度因子就分别是：2（因为2·50=100）和0.5（因为0.5·200=100）。依照Affymetrix公司的标准，用于比较的芯片之间的尺度因子的比例必须小于3，在这个假设中，2/0.5=4，大于3了，说明两块芯片不能用于比较，其中至少有一块出了问题。  

对于每一块芯片，MAS5算法都会针对每一个目标基因做出所谓P/M/A的分类。所谓P(present)就是PM和MM的值有显著差别，指代该基因被检测到；A(absent)就是PM和MM的值没有显著差别，指代该基因未被检测到；而M(marginal present)就是介于这两者之间的临界状态。如果大部分的基因都未被检测到，说明实验出现了问题。而在多组平行实验中，如果其中一组的被检测到的基因和其它组有显著的差别，那说明该实验可能出现了问题。  

对于每一块芯片，所有的MM值做出统计可以得到背景噪音的平均值，最小值和最大值。如果背景噪音的相对于其它平行组来说平均值过大，那也说明该实验可能出现了问题。而往往高的噪音都伴随着低的被检测到的基因比例(low percentage present)，所以这两个可以做为判断实验是否合格的一个指标。  


### Affymetrix 制定的内参  
因为大部分的细胞都有β-actin和GAPDH，所以Affymetrix在大部分的基因芯片里都将它们设置为一组观察RNA降解程度的内参。针对它们的探针组很好的涵盖了3’至5’的每一个区段。通过比较它们3’相对于中间段或者5’的信号强度，可以很好地指示出实验质量。如果比值很高，那可不是一件好事，这表明不完整β-actin或者GAPDH的存在，说明在标记或者杂交的过程中出现了问题。  

为了验证杂交的质量，Affymetrix公司还加入了一些嵌入探针(spike-in probe)。它们分别是BioB(浓度下限)，BioC，BioD和CreX(浓度上限)。它们的RNA是在标记的过程中加入样品体系的。如果BioB不能被MAS5算法标记为P，说明该芯片的敏感度没有达标。这很有可能是芯片本身的问题。  

一般的，如果多个平行实验中，如果有一个芯片各项指标都不太正常，尤其是BioB无法检测到，可以判定为芯片故障。  


```{r}
library(affy)
library(simpleaffy)
library(magrittr)
```


```{r}
pd <- read.AnnotatedDataFrame(filename = "MCF7/mcf7.txt", 
                              header = TRUE, 
                              sep = "\t",
                              row.names = 1)
pd
```

```{r}
pData(pd)
```

```{r}
Data <- ReadAffy(filenames = paste("MCF7/",rownames(pData(pd)), sep = ""), 
                 phenoData = pd, 
                 verbose = T)
```

调用原始数据  
```{r}
pm <- pm(Data)
```

```{r}
mm <- mm(Data)
```

```{r}
gnames <- geneNames(Data)
```

```{r}
pm[1:5, ]
```


```{r}
mm[1:5, ]
```

```{r}
gnames %>% head()
```


### 质量控制  
```{r}
qc_report <- qc(Data)
```


从这里，我们可以看出，QCStats这个结构都包含有哪些数据，它包括：  
    - 尺度因子:scale.factors   
    - 标准化平均值：target  
    - P所占比例：percent.present  
    - 平均背景噪音：average.background    
    - 最小噪音：minimum.background  
    - 最大背景噪音：maximum.background  
    - 嵌入探针BioB：bioBCalls  
    - 嵌入探针：spikes  
    - 质量控制探针beat-action和GAPDH：qc.probes  
    - 以及芯片数据类型：arraytype。


我们一次一览如此多的信息，会让人眼花，我们还是使用simpleAffy提供的方法来一条一条地看信息吧。这里比较重要的方法是：  
    - qcProbes：质量探针  
    - ratios：质量探针5’3’或者5’M比值  
    - spkeInProbes：嵌入探针  
    - sfs：尺度因子  


```{r 5'3' or 5'M ratio}
ratios(qc_report)
```

```{r spike in probe}
spikeInProbes(qc_report)
```

```{r scale factor}
sfs(qc_report)
```

```{r}
qcProbes(qc_report)
```


```{r from simpleAffy}
plot(qc_report)
```

图中浅蓝色的竖条代表着尺度因子正常的取值范围，它会依照实验具体数据来计算出这个范围。通常它应该是在三倍以内，比如从1至-2。很明显，最下面横轴所标记的数字就是尺度因子的座标了。如果所有的一组需要相互比较的芯片间的尺度因子都落在了蓝色范围内，它会以蓝色线条及蓝色端点显示，表明这些芯片可以相互比较，如果标记为红色（比如说这个示例），那就意味着它们不能相互比较。  

最左侧是样品的名字，而后是两个数字，上面的以百分比形式出现的是P所占比重，下面的数字表明平均背景噪音。如果它们标记为红色，说明存在质量问题。  

如果图中出现红色的BioB字样，说明该样品嵌入探针未能检测到BioB。  

actin和GAPDH 3’/5’比值 也分别以△和○表示出来。对于actin的3’/5’应该落在3以内，而对于GAPDH应该落在1左右。如果超过了设定的标准，就会以红色显示。  

简单地讲，如果标记为蓝色，说明正常，如果标记为红色，说明可能存在质量问题。  


### 使用FitPLM生成权重，残差及NUSE图  
使用simpleAffy对基因芯片质量所做出的评估都是基于平均值的，它有一个默认的假设，那就是对于每一块芯片，质量是均匀的，不会因在同一块芯片内部还随着位置的不同而质量发生较大的变化。但事实上往往不是这样。如果我们把芯片划分成许多小格的话，我们会发现格与格之间的质量也是有差异的，这可能是由于芯片印刷的问题，也可能是杂交过程出现的问题，导致了同一块芯片也出现质量不均匀的情况。这种对待芯片的态度，就好象MAS5和RMA之间的差别。  

为此，我们导入affyPLM库。这个库会基于RMA算法来对数据进行预处理，然后给出与质量控制相关的直观图像。  

```{r}
library(affyPLM)
```

```{r}
pset <- fitPLM(object = Data)
```

```{r}
par(mfrow = c(2,2))
image(Data[, 2])
image(pset, type = "weight", which = 2, main = "Weights")
image(pset, type = "resids", which = 2, main = "Residuals")
image(pset, type = "sign.resids", which = 2, main = 'residuals sign')
```

什么是所谓的权重(weight)呢？什么是残差呢(residuals)？如何看懂权重残差图呢？首先我们要了解的是affyPLM库在探针水平(probe-level-model)拟合时所使用的回归方法是最小二乘法，而普通最小二乘法假设误差项的方差是不变的。然而，在基因芯片的应用计算过程中，这一假设是不成立的。所以引入了加权最小二乘法来进行回归。而这个权重呢，就体现着这种方差的变化。残差就是指期待值和观测值之间的差异。因为所有的探针都是随机分布在基因芯片上的，所以我们应该期待权重和残差的分布也应该是随机的。

具体到权重残差图片中来，一般的，在权重图中，绿色代表较低的权重（接近0），白色、灰色代表较高的权重（接近1）；在残差图中，红色代表正的高残差，白色代表低残差，蓝色代表负残差。而sign.resids图使用红色表达正的残差，蓝色表达负的残差。因为我们期待权重和残差都是随机分布的，所以我们应该看到的是绿色均匀分布的权重图，或者红蓝均匀分布的残差图。示例的图片中，我们可以看到在一定程度上芯片的右侧有部分权重及残差分布并不均匀。我们也会注意到，图中会出现一些白色的条块，这是正常的现象，因为有些时候，探什会按照GC比排布从布导致白斑的出现。  

在同一组实验中，即使是相互比较的对照组与实验组之间，大部分基因的表达量还是应该保持一致的，何况平行实验之间。当我们使用相对对数表达(Relative Log Expression(RLE))的的箱线图来控制不同组之间的实验质量时，我们会期待箱线图应该在垂直中央相类的位置（通常非常接近0）。如果有一个芯片的表现和其它的平行组都很不同，那说明它可能出现了质量问题。  

```{r}
library(RColorBrewer)
colors <- brewer.pal(n = 12, name = "Set3")
Mbox(object = pset, ylim = c(-1, 1), col = colors, main = "RLE")
```

相对标准差（Normalized Unscaled Standard Errors(NUSE)）是一种比RLE更为敏感 的质量检测手段。如果你在RLE图当中对某组芯片的质量表示怀疑，那当你使用NUSE图时，这种怀疑就很容易被确定下来。  

NUSE的计算其实也很简单，它是某芯片基因标准差相对于全组标准差的比值。  

我们期待全组芯片都是质量可靠的话，那么，它们的标准差会十分接近，于是它们的NUSE值就会都在1左右。然而，如果有实验芯片质量有问题的话，它就会严重的偏离1，进而影响其它芯片的NUSE值偏向相反的方向。当然，还有一种非常极端的情况，那就是大部分芯片都有质量问题，但是它们的标准差却比较接近，反而会显得没有质量问题的芯片的NUSE值会明显偏离1，所以我们必须结合RLE及NUSE两个图来得出正确的结论。  

```{r}
boxplot(pset, ylim = c(0.95, 1.2), col = colors, main = "NUSE")
```


### RNA 降解曲线及MVA线图  
```{r}
hist(Data[, 1:6], color = colors)
legend("topright", 
       legend = rownames(pData(Data))[1:6], 
       col = colors, 
       lwd = 1, 
       inset = 0.05,
       bty = "n")
```


```{r}
boxplot(Data, col = colors)
```

虽然通常情况下，我们认为，荧光的强度大小与mRNA或者cDNA丰度是成正比的，但是我们知道，尤其是在两极，这个比例关系并不一定存在，比如背景的自发荧光会干扰低表达量的基因检测；而高荧光强度时，荧光检测探头可能会被饱合，而无法区分检测上限以上强度的荧光强度。   

最简单地用于显示原始数据这种荧光强度依赖效应的方法是绘制R-I(ratio-intensity)图，又称MA图。MA图中定义M=log2(R/G); A=1/2·log2(R·G)。图中，Media指示出中值偏离0的程度，IQR是四分位距（interquartile range），两者都是越接近0越好。从图中我们可以看到，原始数据中，中值偏离0，而且头尾两部分都偏离0更远。经过一种标准化的算法处理数据之后，我们发现，数据中值基本为0，头尾的偏离也都被修正了。反过来说，我们对数据绘制RI图可以直观化地显示实验数据进入下一步分析比较时的可靠性。  













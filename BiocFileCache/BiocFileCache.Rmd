---
title: "BiocFileCache"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview  
Organization of files on a local machine can be cumbersome. This is especially true for local copies of remote resources that may periodically require a new download to have the most updated information available. `BiocFileCache` is designed to help manage local and remote resource files stored locally. It provides a convenient location to organize files and once added to the cache management, the package provides functions to determine if remote resources are out of date and require a new download.  

## Creating / Loading the Cache  
The initial step to utilizing `BiocFileCache` in managing files is to create a cache object specifying a location. We will create a temporary directory for use with examples in this vignette. If a path is not specified upon creation, the default location is a directory  ~/.BiocFileCache in the typical user cache directory as defined by `rappdirs::user_cache_dir()`.  

```{r}
library(BiocFileCache)

path <- tempfile()
bfc <- BiocFileCache(cache = path, ask = FALSE)
```

If the path location exists and has been utilized to store files previously, the previous object will be loaded with any files saved to the cache. If the path location does not exist the user will be prompted to create the new directory. If the session is not interactive to promt the user or the user decides not to create the directory a temporary directory will be used.  

Some utility functions to examine the cache are:  
- `bfccache(bfc)`  
- `length(bfc)`  
- `show(bfc)`  
- `bfcinfo(bfc)`  

`bfccache()` will show the cache path. **NOTE**: Because we are using temporary directories, your path location will be different than shown.  

```{r}
bfccache(bfc)
length(bfc)
```

`length()` on a BiocFileCache will show the number of files currently being tracked by the `BiocFileCache`. For more detailed information on what is store in the `BiocFileCache` object, there is a show method which will display the object, object class, cache path, and number of items currently being tracked.  

```{r}
bfc
```

`bfcinfo()` will list a table of `BiocFileCache` resource files being tracked in the cache. It returns a `dplyr` object of class  `tbl_sqlite`.  

```{r}
bfcinfo(bfc)
```

The table of resource files includes the following information:  

- `rid`: resource id. Autogenerated. This is a unique identifier automatically generated when a resource is added to the cache.  
- `rname`: resource name. This is given by the user when a resource is added to the cache. It does not have to be unique and can be updated at anytime. We recommended descriptive key works and identifiers.  
- `create_time`: The date and time a resource is added to the cache.  
- `access_time`: The date and time a resource is utilized within the cache. The access time is updated when the resource is updated or downloaded.  
- `rpath`: resource path. This is the path to the local file.  
- `rtype`: resource type. Either 'local' or 'web', indicating if the resource has a remote origin.  
- `fpath`: If rtype is 'web', this is the link to the remote resource. It will be utilized to download the remote data.  
- `last_modified_time`: For a remote resource, the last_modified (if available) information for the local copy of the data. This information is checked against the remote resource to determine if the local copy is stale and needs to be updated. If it is not available or your resource is not a remote resource, the last modified time will be marked as NA.  
- `etag`:  For a remote resource, the etag (if available) information for the local copy of the data. This information is checked against the remote resource to determine if the local copy is stale and needs to be updated. If it is not available or your resource is not a remote resource, the etag will be marked as NA.  
- `expires`: For a remote resource, the expires (if available) information for the local copy of the data. This information is checked against the `Sys.time` to determine if the local copy needs to be updated. If it is not available or your resource is not a remote resource, the expires will be marked as NA.  

Now that we have created the cache object and location, letâ€™s explore adding files that the cache will manage!  

## Adding / Tracking Resources  
Now that a `BiocFileCache` object and cache location has been created, files can be added to the cache for tracking. There are two functions to add a resource to the cache:  

- `bfcnew()`  
- `bfcadd()`  

The difference between the options: `bfcnew()` creates an entry for a resource and returns a filepath to save to. As there are many types of data that can be saved in many different ways, `bfcnew()` allows you to save any R data object in the appropriate manner and still be able to track the saved file. `bfcadd()` should be utilized when a file already exists or a remote resource is being accessed.  

`bfcnew()` takes the `BiocFileCache` object and a user specified `rname` and returns a path location to save data to. (optionally) you can add the file extension if you know the type of file will be saved.  

```{r}
savepath <- bfcnew(x = bfc, rname = "NewResource", ext = ".RData")

# now we can use that path in any save function
m <- matrix(1:12, nrow = 3)
save(m, file = savepath)

# and that file will be tracked in the cache
bfcinfo(bfc)
```

`bfcadd()` is for existing files or remote resources. The user will still specify an `rname` of their choosing but also must specify a path to local file or web resource as `fpath`. If no `fpath` is given, the default is to assume the `rname` is also the path location. If the `fpath` is a local file, there are a few options for the user determined by the action argument. action will allow the user to either `copy` the existing file into the cache directory, `move` the existing file into the cache directory, or leave the file whereever it is on the local system yet still track through the cache object  `asis`. copy and move will rename the file to the generated cache file path. If the `fpath` is a remote source, the source will try to be downloaded, if it is successful it will save in the cache location and track in the cache object; The original source will be added to the cache information as fpath. If the user does not want the remote resource to be downloaded initially, the argument `download=FALSE` may be used to delay the download but add the resource to the cache. Relative path locations may also be used, specified with` rtype = "relative"`. This will store a relative location for the file within the cache; only actions copy and move are available for relative paths.  





































